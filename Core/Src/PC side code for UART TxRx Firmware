#include <stdio.h>
#include <stdlib.h>
#include <Windows.h>

int main(){

HANDLE serial_port = CreateFile("\\\\.\\COM4", GENERIC_READ | GENERIC_WRITE , 0,NULL,OPEN_EXISTING,FILE_ATTRIBUTE_NORMAL,NULL);
FILE* file_pointer;
char tx_data;
char rx_data[1010];
char start[1]={'1'};
char res[1];
int i=0;

DCB PortParas = {0};
PortParas.DCBlength = sizeof(PortParas);
if(GetCommState(serial_port, &PortParas)){

PortParas.BaudRate = CBR_2400;
PortParas.ByteSize = 8;
PortParas.StopBits = ONESTOPBIT;
PortParas.Parity = NOPARITY;
}

else{
printf("Error getting Serial Port\n");
CloseHandle(serial_port);
return 1;
}

SetCommState(serial_port, &PortParas);

DWORD bytes_written;
DWORD bytes_read;

WriteFile(serial_port, start, 1, &bytes_written, NULL);
printf("Transmission Request Sent\n");

ReadFile(serial_port, &res[0], 1, &bytes_read, NULL);
if(res[0]=='1'){
printf("Transmission starting\n");
	file_pointer = fopen("tx_file.txt","r");
	if(file_pointer == NULL){
	  printf("File not found\n");
	  return 1;
	  }
	while((tx_data = fgetc(file_pointer))!=EOF){
	  WriteFile(serial_port, &tx_data, sizeof(tx_data), &bytes_written, NULL);
	  printf("%c", tx_data);
	  }
}
else{
	printf("No Acknowledgement Received");
	return 1;
}

printf("\nTransmission Complete\n");
WriteFile(serial_port, start, 1, &bytes_written, NULL);
printf("Ready To Receive\n");
if(!(ReadFile(serial_port, &res[0], 1, &bytes_read, NULL)))
{
printf("Reception Failed");
return 1;
}
printf("Reception Starting\n");
do{
ReadFile(serial_port, &rx_data[i], 1, &bytes_read, NULL);
printf("%c", rx_data[i]);
}while(rx_data[i]!='\0');

printf("\nReception Complete\n");
	
fclose(file_pointer);
CloseHandle(serial_port);
return 0;
}

